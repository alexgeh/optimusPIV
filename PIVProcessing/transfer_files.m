%%
% transfer_files
% Moves files of a specified type from a source folder to a destination folder.
%
% This function is typically used to:
%   (1) Transfer `.mraw` and `.cihx` files after a recording
%   (2) Transfer `.vc7` files after post-processing
%
% Assumptions:
%   - For 'mraw': `recording_log.json` exists in the source folder and was created by the recording software.
%   - For 'vc7' : `processing_log.json` exists in the source folder and contains case tracking.
%   -           : name of folder generated by DaVis processing has been updated (eg - 'PIV_SP(1x64x64_0%ov_ImgCorr)')
%
% INPUTS:
%   sourceFolder      - [char] Path to the folder containing the files to be moved.
%   fileDestination   - [char] Path to the destination folder.
%   fileType          - [char] Either 'mraw' or 'vc7' (case-sensitive); determines which files to move.
%
% OUTPUTS:
%   None (side effect: moves files; prints status messages or warnings if errors occur)

function transfer_files(sourceFolder, fileDestination, caseIdx, fileType)

if fileType == "mraw"
    % --- Transfer .mraw and .cihx files ---
   
    % Read the recording log to determine latest case number
    % rec_log = read_recording_log(fullfile(sourceFolder, 'recording_log.json'));
    % caseNumber = sprintf('%04d', int32(rec_log.n_recorded)); % Format case number with leading zeros
    caseString = sprintf('%04d', caseIdx); % Format case number with leading zeros
   
    % Construct file paths for .cihx and .mraw files
    fileList = {
        % fullfile(sourceFolder, ['ms', caseNumber, '.cihx']);
        fullfile(sourceFolder, ['ms', caseString, '.mraw'])
    };
   
    % Attempt to copy each file to the destination
    for i = 1:length(fileList)
        sourceFile = fileList{i};
        try
            copyfile(sourceFile, fileDestination);
        catch ME
            warning('Error during file transfer of %s:\n\n%s', sourceFile, ME.message)
        end
    end
   
    disp(".mraw file transfer complete.");

elseif fileType == "vc7"
    % --- Transfer .vc7 files from processed PIV folder ---
   
    % Read the processing log to determine latest case number
    % proc_log = read_processing_log(fullfile(sourceFolder, 'processing_log.json'));
    % caseNumber = sprintf('%04d', int32(proc_log.n_recorded)); % Format case number with leading zeros
    caseString = sprintf('ms%04d', caseIdx); % Format case number with leading zeros
   
    % Construct target subfolder name (e.g., .../ms0005/)
    % fileDestinationCase = fullfile(fileDestination, caseString);

    % Check if target project folder exists
    % ensureTopLevelFolder(fileDestinationCase);

    moveNewestImgCorrFolder(sourceFolder, fileDestination, caseString);
   
    % % Get list of .vc7 files in the specific PIV subdirectory
    % fileList = dir(fullfile(sourceFolder, 'PIV_SP(1x48x48_0%ov_ImgCorr)', '*.vc7'));
    % 
    % % Attempt to copy each .vc7 file
    % for i = 1:length(fileList)
    %     sourceFile = fullfile(fileList(i).folder, fileList(i).name);
    %     try
    %         copyfile(sourceFile, fileDestinationCase);
    %     catch ME
    %         warning('Error during file transfer of %s:\n\n%s', sourceFile, ME.message)
    %     end
    % end
    % 
    % disp(".vc7 file transfer complete.");

else
    error("Invalid input for fileType. Choose either 'mraw' or 'vc7'.");
end

end




%%
%%Limited functionality version.
        
% function transferFiles(sourceFolder, fileDestination)
%     fileList = {[sourceFolder,'\Camera1.cih'],[sourceFolder,'\Camera1.mraw']}; %Selects necessary files to be transferred.
%     for i = 1:length(fileList)
%         sourceFile = fileList{i};
%         try copyfile(sourceFile, fileDestination);
%         catch ME
%         warning('Error during file transfer of %s:\n%s', sourceFile, ME.message)
%         end
%     end
%     disp(".mraw file transfer complete.");
% end